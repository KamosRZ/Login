<!doctype html>
<html lang="bg">
	<head>
	    <meta charset="utf-8"/>
	    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	    <title>Login</title>
	    <meta name="description" content=""/>
	    <meta name="viewport" content="width=device-width"/>
	    <base href="/"/>
	    <link rel="stylesheet" type="text/css" href="webjars/bootstrap/3.2.0/css/bootstrap.min.css"/>
	    <link rel="stylesheet" type="text/css" href="webjars/font-awesome/4.7.0/css/font-awesome.css"/>
	    <link rel="stylesheet" type="text/css" href="webjars/bootstrap-social/5.1.1/bootstrap-social.css"/>
	</head>
	
	<body>
		<nav class="navbar navbar-default">
		  <div class="container-fluid">
		    <div class="navbar-header">
		      <a class="navbar-brand" href="/">Ultimatum game</a>
		    </div>
		    <div class="authenticated">
		    	<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1" style="display: none;">
			      <ul class="nav navbar-nav navbar-right">
			      	<p class="navbar-text">Signed in as <span id="user"></span></p>
			        <li><a href="#" onClick="logout()">Logout</a></li>
			      </ul>
		    	</div>
		    </div>
		  </div>
		</nav>
		<div class="container unauthenticated">
			<a class="btn btn-block btn-social btn-facebook" href="/login/facebook">
	    		<span class="fa fa-facebook"></span> Sign in with Facebook
	  		</a>
		</div>	
		<div class="authenticated">
			<div class="menu">
				<input type="hidden" name="userid" id="userid">
				<fieldset class="form-group">
				    <legend>Menu</legend>
				    <div class="form-check">
				      <label class="form-check-label">
				        <input type="radio" class="form-check-input" name="action" id="start-radio" value="start">
				        Start new game
				      </label>
				    </div>
				    <div class="form-check">
				    	<label class="form-check-label">
				        	<input type="radio" class="form-check-input" name="action" id="join-radio" value="join">
				        Join game
				      	</label>
				    </div>
			  </fieldset>
			  <div class="form-group role-container">
			    <label for="role-select">Select role</label>
			    <select class="form-control" id="role" name="role">
			      <option value="1">Proposer</option>
			      <option value="2">Responder</option>
			    </select>
			  </div>

			<div class="form-group games-list-container" style="display: none;">
				<label for="games-select">Select game to join</label> <select
					class="form-control" id="games-select" name="games-select">
				</select>
			</div>

			<button type="submit" class="btn btn-primary" id="submit">Go !</button>
			</div>
			<div class="game-container">
				<span class="game-id"></span>
				<br/>
				<span class="game-label"></span>
			</div>
		</div>	
		<script type="text/javascript" src="webjars/jquery/jquery.min.js"></script>
	    <script type="text/javascript" src="webjars/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	    <script type="text/javascript" src="webjars/js-cookie/js.cookie.js"></script>
		
	    <script type="text/javascript">
	    
		    $( document ).ready(function() {
			    $( "#submit" ).click(function() {
			    	if ($('#start-radio').is(':checked')) {
				    	$.get('/game/create', { userid: $("#userid").val(), role : $("#role").val()}, 
				    		    function(gameId){
				    				$(".menu").hide();
				    				$(".game-id").text("Created game id: " + gameId);
				    				$(".game-label").text("Waiting for second player to join...");
				    				var intervalId = setInterval(function(){
				    					$.get( "/game/check/" + gameId, function( data ) {
				    						  if (data == 4 || data == 5) {
				    							  $(".game-label").text("Second player joined !"); 
				    							  clearInterval(intervalId);
				    						  }
				    						});
				    				}, 5000);
				    		});
			    	}
			    	if ($('#join-radio').is(':checked')) {
			    		$.get('/game/join', { userid: $("#userid").val(), gameid: $('#games-select').val()}, 
				    		    function(gameId){
				    				$(".menu").hide();
				    				$(".game-id").text("Joined to game id: " + $('#games-select').val());
				    		});
			    	}
				});
			    
			    $( "#join-radio" ).click(function() {
			    	$( ".role-container" ).hide();
			    	$.get("https://ug-game-api.azurewebsites.net/api/games/to_join", function(response){
			    		$.each(response.data.games, function(key, value) {   
			    		     $('#games-select')
			    		         .append($("<option></option>")
			    		                    .attr("value",value.gameID)
			    		                    .text(value.gameID)); 
			    		});
			    	});
					$(".games-list-container").show();
				});
			    
		    	$( "#start-radio" ).click(function() {
			    	$( ".role-container" ).show();
			    	$(".games-list-container").hide();
			    });
			    
			   	$(".role-container").hide();
			    $(".authenticated").hide();
		    });
	    
		    $.get("/user", function(data) {
		        $("#user").html(data.userAuthentication.details.name);
		        $(".unauthenticated").hide()
		        $(".authenticated").show()      
		    $.ajax
		      ({
		        type: "POST",
		        url: 'https://test-api-provider.com/user-service/api/user/create',
		        dataType: 'json',
		        contentType: 'application/json',
		        async: false,
		        data: JSON.stringify({"token": data.userAuthentication.details.id, "name" : data.userAuthentication.details.name}),
		        success: function (response) {
		        	$("#userid").val(response.id);
		        }
		      });   
		    });
	
		    var logout = function() {
		     $.post("/logout", function() {
		        $("#user").html('');
		        $(".unauthenticated").show();
		        $(".authenticated").hide();
		     })
		     return true;
		    }
		    
		    $.ajaxSetup({
		     beforeSend : function(xhr, settings) {
		      if (settings.type == 'POST' || settings.type == 'PUT'
		       || settings.type == 'DELETE') {
		       if (!(/^http:.*/.test(settings.url) || /^https:.*/
		         .test(settings.url))) {
		         xhr.setRequestHeader("X-XSRF-TOKEN",
		         Cookies.get('XSRF-TOKEN'));
		       }
		      }
		     }
		    });
		</script>
	</body>

</html>
